---
title: "Analyses"
author: "Nate Breznau"
date: "5/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load("tidyverse", "zoo", "ggplot2", "ragg", "lme4", "ggrepel", "ggpubr", "jtools", "webshot", "sjPlot")
```


### Load Data

Data files were worked up from raw data in the folder "data/data_prep_routines".

```{r files, warning = F, message = F}

covid <- readRDS(here::here("data","covid.RDS"))

```

#### Set up lags

```{r ts_prep}
covid <- covid %>%
  mutate(dv = infection_day_pc18,
         sent_lag2 = lag(sent, 2), # simple sentiment lag
         sent_avg_lag = (lag(sent,5)+lag(sent,4)+lag(sent,3)+sent_lag2)/4, # average over 4 days w/ lag2
         gov_int_lag2 = lag(StringencyIndex, 2),
         cases_lag5 = lag(cases_week_delta, 5),
         infect_lag5 = lag(infection_day_pc18, 5),
         gdp10k = gdp_cap/10000,
         polity2_ii = polity2_i*-1,
         infection_day_delta_lead5 = lead(infection_day_delta, 5)) # inverse scale to make authoritarianism higher values
```

### Model Plan

```{r model}
knitr::include_graphics(here::here("results","Twitter_pre_reg.png"))
```


### Analysis



#### Behavior and Concern Association

```{r behave_concern}
agg_png(filename = here::here("results","concerns_behaviors.png"), width = 1200, height = 750, res = 144)
covid %>%
  mutate(label_p = ifelse(iso_period == "TWN1", "Taiwan\n31-Mar",
                   ifelse(iso_period == "ITA2", "Italy\n01-Apr",
                   ifelse(iso_period == "DEU3", "Germany\n04-Apr",
                   ifelse(iso_period == "CHN1", "China\n31-Mar",
                   ifelse(iso_period == "JPN3", "Japan\n04-Apr", 
                   ifelse(iso_period == "ZAF1", "South Africa\n31-Mar", NA))))))) %>%
  ggplot(aes(x = concern_self, y = behave_3roll_prefill, label = label_p)) +
  geom_smooth(method = "lm", color = "#238A8DFF") +
  geom_point(color = "#73D055FF") +
  geom_label_repel(label.size = NA, size = 4, 
                   max.overlaps = 3, color = "#440154FF",
                   fill = NA) +
  scale_x_continuous(limits = c(3.69,5.5), expand = c(0,0)) +
  ylim(-0.8,0.7) +
  xlab("Risk Perceptions") +
  ylab("Precautionary Behaviors") +
  labs(caption = "Source: COVIDiSTRESS & COVID-19 Attitudes and Beliefs surveys") +
  
  stat_cor(method = "pearson", label.x = 5, label.y = -0.75) +
  theme_classic()
dev.off()

knitr::include_graphics(here::here("results","concerns_behaviors.png"))
```



#### Basic model of INFECTION

```{r m_basic}

m1 <- lmer(dv ~ sent_avg_lag + gov_int_lag2 + cases_lag5 + infect_lag5 + (1|iso3c), data = covid)

summary(m1)

```



#### Basic model of GOV INTERVENTION

##### Regressions predicting gov int

```{r m_govint}

m11 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + (1|iso3c), data = covid)
m12 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + gdp10k + (1|iso3c), data = covid)
m13 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + gov_prot + (1|iso3c), data = covid)

m14 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + gini_disp + (1|iso3c), data = covid)
m15 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + polity2_ii + (1|iso3c), data = covid)
m16 <- lmer(StringencyIndex ~ cases_lag5 + infect_lag5 + sent_avg_lag + gdp10k + gov_prot + gini_disp + polity2_ii + (1|iso3c), data = covid)
#summary(m12)

# take predicted values to adjust for government over or under interveneing 

covid$gov_int_pred <- predict(m11, newdata = covid, allow.new.levels = T)
covid$gov_int_pred_resid <- covid$StringencyIndex - covid$gov_int_pred
```

##### Regressions predicting infect

```{r m_govint}

covid2 <- covid %>%
  mutate(dv2 = lead(dv, 2),
         gov_int_lag2 = scale(lag(gov_int_pred_resid, 2)),
         cases_lag5 = scale(cases_lag5),
         infect_lag5 = scale(lag(infection_day_pc_3roll, 7)),
         sent_avg_lag = scale(sent_avg_lag))

m111 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + (1|iso3c), data = covid2)
m112 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + gdp10k + (1|iso3c), data = covid2)
m113 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + gov_prot + (1|iso3c), data = covid2)

m114 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + gini_disp + (1|iso3c), data = covid2)
m115 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + polity2_ii + (1|iso3c), data = covid2)
m116 <- lmer(dv2 ~ gov_int_lag2 + cases_lag5 + infect_lag5 + sent_avg_lag + gdp10k + gov_prot + gini_disp + polity2_ii + (1|iso3c), data = covid2)

m117 <- lmer(dv2 ~ gov_int_lag2 + gov_int_lag2*gov_prot + cases_lag5 + infect_lag5 + sent_avg_lag + sent_avg_lag*gov_prot + gov_prot + sent_avg_lag*gov_int_lag2 + sent_avg_lag*gov_int_lag2*gov_prot + (1|iso3c), data = covid2)
summary(m117)
```

##### Coef plots

```{r m_govint_coefplot}
agg_png(filename = here::here("results","govint.png"), width = 1200, height = 700, res = 144)

plot_coefs(m11,m12,m13,m14,m15,m16,
           coefs = c("Confirmed Cases, t-5" = "cases_lag5",
                     "Infection Rate, t-5" = "infect_lag5",
                     "Media Sentiment, past week" = "sent_avg_lag",
                     "GDP, per capita 10k" = "gdp10k",
                     "Welfare State\nStrength" = "gov_prot",
                     "Income Inequality, disposable\n(114 countries)" = "gini_disp",
                     "Authoritarian Rule" = "polity2_ii"),
           colors = c("#73D055FF","#482677FF","#DCE319FF","#404788FF","#238A8DFF","#73D055FF")) +
  xlab(label = "Coefficients & 95%CI") +
  coord_cartesian(xlim = c(-4,4)) +
  theme(legend.position = "none",
        axis.text.y = element_text(color = "black", hjust = 0),
        axis.title.x = element_text(color = "black")
  )

dev.off()

knitr::include_graphics(here::here("results","govint.png"))
```
```{r m_infect_coefplot}
agg_png(filename = here::here("results","infect.png"), width = 1200, height = 700, res = 144)
plot_coefs(m111,m112,m113,m114,m115,m116,
           coefs = c("Goverment Intervention, t-4" = "gov_int_lag2",
                     "Confirmed Cases, t-7" = "cases_lag5",
                     "Infection Rate, t-7" = "infect_lag5",
                     "Media Sentiment, past week" = "sent_avg_lag",
                     "GDP, per capita 10k" = "gdp10k",
                     "Welfare State\nStrength" = "gov_prot",
                     "Income Inequality, disposable\n(114 countries)" = "gini_disp",
                     "Authoritarian Rule" = "polity2_ii"),
           colors = c("#73D055FF","#482677FF","#DCE319FF","#404788FF","#238A8DFF","#73D055FF")) +
  xlab(label = "Coefficients & 95%CI") +
  #coord_cartesian(xlim = c(-4,4)) +
  theme(legend.position = "none",
        axis.text.y = element_text(color = "black", hjust = 0),
        axis.title.x = element_text(color = "black")
  )
dev.off()

knitr::include_graphics(here::here("results","infect.png"))
```
##### Plot 

```{r govint_sent}
m117plot <- plot_model(m117, type = "pred", terms = c("gov_int_lag2", "sent_avg_lag [-0.8,0.8]", "gov_prot [-0.8,0.8]"))

agg_png(file = here::here("results/sent_int.png"), width = 1200, height = 700, res = 144)
m117plot + labs(title = "", x = "Government Intervention", y = "Infection Rate") +
  scale_color_manual(name="Media\nSentiment",
                       labels=c("Negative","Positive"),
                       values=c("#482677FF","#238A8DFF")) +
  xlim(-2.1,2.1) +
    theme(panel.background = element_blank(),
          axis.line = element_line(color = "black"),
          legend.spacing.x = unit(0.5, 'cm'),
          legend.text = element_text(margin = margin(t = 5), size = 12),
          legend.title = element_text(size = 14),
          axis.title = element_text(size = 14))
dev.off()
knitr::include_graphics(here::here("results/sent_int.png"))
```



```{r int_inf_welflow}
#mid <- mean(covid$gov_int_pred_resid, na.rm = T)

covid2 %>%
  subset(gov_prot < -0.4) %>%
ggplot() +
  geom_smooth(aes(x=gov_int_pred_resid, y=dv2, color = iso3c), method=lm, se=FALSE) +
  #geom_text_repel(aes(label = iso3c), size = 2.5) +
  #scale_color_gradient2(midpoint=mid, low="#DCE319FF", mid="#238A8DFF", high="#482677FF", space="Lab") +
  labs(x= "Government Intervention (t-4), Residual", y = "Infection Rate (t)", color = "Welfare State\nStrength") +
  theme_classic() +
  theme(
    legend.position = "none"
  )

```

```{r int_inf_welfmid}
#mid <- mean(covid$gov_int_pred_resid, na.rm = T)

covid2 %>%
  subset(gov_prot > -0.4 & gov_prot < 0.4) %>%
ggplot() +
  geom_smooth(aes(x=gov_int_pred_resid, y=dv2, color = iso3c), method=lm, se=FALSE) +
  #geom_text_repel(aes(label = iso3c), size = 2.5) +
  #scale_color_gradient2(midpoint=mid, low="#DCE319FF", mid="#238A8DFF", high="#482677FF", space="Lab") +
  labs(x= "Government Intervention (t-4), Residual", y = "Infection Rate (t)", color = "Welfare State\nStrength") +
  theme_classic() +
  theme(
    legend.position = "none"
  )

```

```{r int_inf_welfhigh}
#mid <- mean(covid$gov_int_pred_resid, na.rm = T)

covid2 %>%
  subset(gov_prot > 0.4) %>%
ggplot() +
  geom_smooth(aes(x=gov_int_pred_resid, y=dv2, color = iso3c), method=lm, se=FALSE) +
  #geom_text_repel(aes(label = iso3c), size = 2.5) +
  #scale_color_gradient2(midpoint=mid, low="#DCE319FF", mid="#238A8DFF", high="#482677FF", space="Lab") +
  labs(x= "Government Intervention (t-4), Residual", y = "Infection Rate (t)", color = "Welfare State\nStrength") +
  theme_classic() +
  theme(
    legend.position = "none"
  )

```
##### Regression Models Gov Int

```{r m_govint_tables}
tab_model(m111,m112,m113,m114,m115,m116, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F, rm.terms = c("(Intercept)"), show.loglik = T, show.aic = T, dv.labels = c("M11","M12","M13", "M14","M15","M16"), pred.labels = c("Goverment Intervention, t-4", "Confirmed Cases, t-7", "Infection Rate, t-7", "Media Sentiment, past week", "GDP, per capita 10k", "Welfare State\nStrength", "Income Inequality,\ndisposable", "Authoritarian Rule"), file = here::here("results","Tbl3.html"))

webshot(here::here("results","Tbl3.html"), file = here::here("results","Tbl3.png"))

knitr::include_graphics(here::here("results","Tbl3.png"))
```
##### Regression Models Infect Rate

```{r m_govint_tables}
tab_model(m11,m12,m13,m14,m15,m16, p.style = "stars", p.threshold = c(0.10, 0.05, 0.01), show.ci = F, rm.terms = c("(Intercept)"), show.loglik = T, show.aic = T, dv.labels = c("M11","M12","M13", "M14","M15","M16"), pred.labels = c("Confirmed Cases, t-5", "Infection Rate, t-5", "Media Sentiment, past week", "GDP, per capita 10k", "Welfare State\nStrength", "Income Inequality,\ndisposable", "Authoritarian Rule"), file = here::here("results","Tbl2.html"))

webshot(here::here("results","Tbl2.html"), file = here::here("results","Tbl2.png"))

knitr::include_graphics(here::here("results","Tbl2.png"))
```
